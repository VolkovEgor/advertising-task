# Тестовое задание Merchant Experience

[![Build Status](https://travis-ci.com/architectv/merchantx-task.svg?token=fKJi943rZDkZWG4i8spC&branch=main)](https://travis-ci.com/architectv/merchantx-task)

<!-- ToC start -->
# Содержание

1. [Описание задачи](#Описание-задачи)
1. [Реализация](#Реализация)
1. [Архитектура](#Архитектура)
1. [Endpoints](#Endpoints)
1. [Запуск](#Запуск)
1. [Тестирование](#Тестирование)
1. [Документация](#Документация)
1. [Нагрузочное тестирование](#Нагрузочное-тестирование)
1. [Примеры](#Примеры)
<!-- ToC end -->

# Описание задачи
Необходимо создать сервис для хранения и подачи объявлений. Объявления должны храниться в базе данных. Сервис должен предоставлять API, работающее поверх HTTP в формате JSON.

**Метод получения списка объявлений**
* Пагинация: на одной странице должно присутствовать 10 объявлений;
* Cортировки: по цене (возрастание/убывание) и по дате создания (возрастание/убывание);
* Поля в ответе: название объявления, ссылка на главное фото (первое в списке), цена.

**Метод получения конкретного объявления**
* Обязательные поля в ответе: название объявления, цена, ссылка на главное фото;
* Опциональные поля (можно запросить, передав параметр fields): описание, ссылки на все фото.

**Метод создания объявления:**
* Принимает все вышеперечисленные поля: название, описание, несколько ссылок на фотографии (сами фото загружать никуда не требуется), цена;
* Возвращает ID созданного объявления и код результата (ошибка или успех).

# Реализация

- Следование дизайну REST API.
- Подход "Чистой Архитектуры" и техника внедрения зависимости.
- Работа с фреймворком [echo](https://echo.labstack.com/).
- Работа с БД Postgres с использованием библиотеки [sqlx](https://github.com/jmoiron/sqlx) и написанием SQL запросов.
- Конфигурация приложения - библиотека [viper](https://github.com/spf13/viper).
- Запуск из Docker.
- Юнит-тестирование уровней обработчиков, бизнес-логики и взаимодействия с БД классическим способом и с помощью моков - библиотеки [testify](https://github.com/stretchr/testify), [mock](https://github.com/golang/mock).
- Сквозное (E2E) тестирование - BDD фреймворк [goconvey](https://github.com/smartystreets/goconvey).
- Проверка кода на соответствие стандартам с помощью линтера - утилита [golangci-lint](https://github.com/golangci/golangci-lint)
- Автоматическое создание документации с помощью Swagger 2.0 - библиотека [echo-swagger](https://github.com/swaggo/echo-swagger).
- Непрерывная интеграция - сборка приложения, проверка линтером и запуск тестов в Github action.

**Структура проекта:**
```
.
├── pkg
│   ├── model       // основные структуры
│   ├── handler     // обработчики запросов
│   ├── service     // бизнес-логика
│   └── repository  // взаимодействие с БД
├── cmd             // точка входа в приложение
├── migrations      // SQL файлы с миграциями
├── scripts         // SQL файлы с тестовыми данными
├── configs         // файлы конфигурации
├── test            // инициализация тестовой БД
└── e2e_test.go     // сквозной тест
```

# Архитектура

# Endpoints

- GET /api/adverts - получение списка объявлений
    - Параметры запроса:
        - page - номер страницы,
        - sort - сортировка.
- GET /api/adverts/:id - получение объявления по id
    - Параметры запроса:
            - fields - флаг, если равен True, то вернуть все поля, иначе вернуть название, ссылку на главное фото и цену.
- POST /api/adverts - создание объявления
    - Тело запроса:
        - title - название объявления,
        - description - описание объявления,
        - photos - ссылки на фотографии,
        - price - цена.

# Запуск

```
make build
make run
```

Если приложение запускается впервые, необходимо применить миграции к базе данных:

```
make migrate_up
```

# Тестирование

Локальный запуск тестов:
```
make run_test
```

Для локального запуска тестов необходимо создать тестовую БД. Это можно сделать следующей командой (необходима утилита psql):
```
make create_test_db
```
# Документация

Для просмотра документации Swagger необходимо запустить приложение и перейти по [ссылке](http://127.0.0.1:9001/swagger/index.html) 

# Примеры

Запросы сгенерированы из Postman для cURL.

## Получение списка объявлений

### 1. GET для _page=1_ (без сортировки)

**Запрос:**
```
$ curl GET localhost:9001/api/adverts?page=1
```
**Тело ответа:**
```
[
    {
        "id": 1,
        "title": "Advert 1",
        "main_photo": "link1",
        "price": 10000
    },
    {
        "id": 2,
        "title": "Advert 2",
        "main_photo": "link1",
        "price": 60000
    },
    {
        "id": 3,
        "title": "Advert 3",
        "main_photo": "link1",
        "price": 30000
    }
]
```

### 2. GET для _page=1_ и _sort_=price_asc

**Запрос:**
```
$ curl GET localhost:9001/api/adverts?page=1&sort=price_asc
```
**Тело ответа:**
```
[
    {
        "id": 1,
        "title": "Advert 1",
        "main_photo": "link1",
        "price": 10000
    },
    {
        "id": 3,
        "title": "Advert 3",
        "main_photo": "link1",
        "price": 30000
    },
    {
        "id": 2,
        "title": "Advert 2",
        "main_photo": "link1",
        "price": 60000
    }
]
```

### 3. GET для _page=1_ и _sort_=date_desc

**Запрос:**
```
$ curl GET localhost:9001/api/adverts?page=1&sort=date_desc
```
**Тело ответа:**
```
[
    {
        "id": 3,
        "title": "Advert 3",
        "main_photo": "link1",
        "price": 30000
    },
    {
        "id": 2,
        "title": "Advert 2",
        "main_photo": "link1",
        "price": 60000
    },
    {
        "id": 1,
        "title": "Advert 1",
        "main_photo": "link1",
        "price": 10000
    }
]
```

## Получение конкретного объявления

### 1. GET для _id=1_ 

**Запрос:**
```
$ curl GET localhost:9001/api/adverts/1
```
**Тело ответа:**
```
{
    "id": 1,
    "title": "Advert 1",
    "photos": [
        "link1"
    ],
    "price": 10000
}
```
### 2. GET для _id=1_ и _fields_=true

**Запрос:**
```
$ curl GET localhost:9001/api/adverts/1?fields=true
```
**Тело ответа:**
```
{
    "id": 1,
    "title": "Advert 1",
    "description": "Description 1",
    "photos": [
        "link1",
        "link2",
        "link3"
    ],
    "price": 10000
}
```

## Создание объявления

**Запрос:**
```
$ curl --location --request POST 'localhost:9001/api/adverts' \
--header 'Content-Type: application/json' \
--data-raw '{
    "title": "New advert",
    "description": "Description of new advert",
    "photos": ["link1", "link2"],
    "price": 400000
}'
```
**Тело ответа:**
```
{
    "advert_id": 13
}
```